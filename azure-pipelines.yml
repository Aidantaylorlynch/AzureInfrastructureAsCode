trigger:
  - master

stages:
  - stage: Publish
    displayName: Publish ARM template to staging
    jobs:
     - job: Publish
       displayName: Publish
       pool:
        vmImage: 'windows-2019'
       steps:
         - task: PublishBuildArtifacts@1
           inputs:
             PathtoPublish: $(Build.SourcesDirectory)/ARMTemplates
             publishLocation: FilePath
             TargetPath: $(Build.ArtifactStagingDirectory)
             ArtifactName: ARMTemplates

  - stage: Deploy
    displayName: Deploy ARM template
    jobs:
      - job: Deploy
        displayName: Deploy
        pool:
          vmImage: 'windows-2019'
        steps:
          - task: AzureResourceGroupDeployment@2
            inputs:
              azureSubscription: ARMServiceConnection
              action: Create Or Update Resource Group
              deploymentMode: Complete
              resourceGroupName: Multi
              templateLocation: Linked artifact    
              csmFile: $(Build.ArtifactStagingDirectory)/ARMTemplates)          